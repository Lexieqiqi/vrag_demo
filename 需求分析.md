# vrag_demo 视频查询系统 - 需求分析

## 1. 项目概述

**项目名称**：视频查询系统（`vrag_demo`）

**项目描述**：该系统允许用户通过网页界面上传视频，系统将视频拆分为帧，并对每帧计算嵌入向量，将其与视频和帧信息存储到数据库中。用户可通过文本或语音输入进行搜索，系统会返回最相似的帧，并从该帧开始播放相应视频。该项目旨在演示如何快速定位视频中的特定片段。

## 2. 功能需求

### 2.1 前端功能

- **用户上传视频**
  - 提供视频上传区域，支持拖拽上传和点击选择文件。
  - 通过文件选择器上传视频到服务器。
  - 展示上传进度条或其他上传状态信息。

- **搜索功能**
  - 文本搜索：提供输入框，用户可输入要查找的内容。
  - 语音搜索：提供语音输入按钮，将语音转换为文本后查询。
  - 支持模糊搜索，返回与输入文本最相似的帧。

- **搜索结果展示**
  - 显示搜索结果的帧缩略图。
  - 可视化相似度得分。
  - 从匹配帧开始播放对应的视频。

- **响应式界面**
  - 在不同设备上自适应显示，包括桌面和移动端。
  - 上传区域、搜索框、展示区域等内容应具备清晰的交互提示和动画效果。

### 2.2 服务器端功能

- **视频帧提取**
  - 使用MoviePy或其他库从上传的视频中提取帧，确保高质量和适当间隔。
  - 将提取的帧保存到服务器端的`frames`文件夹中。

- **嵌入计算**
  - 利用OpenAI的CLIP模型计算每帧的嵌入向量。
  - 保存嵌入向量至数据库，并包含视频名称、视频ID和帧时间等元数据。

- **搜索与查询**
  - 在数据库中根据文本或语音输入的嵌入向量，找到最相似的帧嵌入向量。
  - 返回匹配度最高的帧信息及帧在视频中的位置。

- **视频播放控制**
  - 从指定帧位置开始播放视频，返回视频的播放路径或实时流。

### 2.3 数据库功能

- **存储结构**
  - 存储视频、帧的路径及嵌入数据。
  - 存储视频相关元数据，如视频ID、名称和帧信息。
  - 索引嵌入向量，提高搜索性能。

## 3. 非功能需求

- **性能**
  - 视频帧提取和嵌入计算应保持高效，单个视频的处理时间不应超过合理限度。
  - 检索应在几秒内完成并返回相似度最高的帧。

- **可靠性**
  - 系统应能够正常处理大量视频上传和检索请求。
  - 当视频或帧嵌入存储失败时，应提供适当的错误提示。

- **可扩展性**
  - 允许添加更多视频查询特性。
  - 适应更大数据库（如分布式存储）或云端存储。

- **兼容性**
  - 系统应兼容主流浏览器和移动设备。

- **用户体验**
  - 提供友好的交互界面，搜索结果呈现清晰。

## 4. 项目结构

项目结构按照功能模块划分，以清晰地组织前端、服务器端、数据库文件和静态资源。

- **`server`**：服务器端代码，包括`app.py`、`vrag_service.py`等，负责后端逻辑处理。
- **`database`**：数据库及嵌入管理文件夹，`models.py`定义表结构和嵌入数据的管理逻辑。
- **`frontend`**：前端代码，包括`index.html`、样式文件和JavaScript脚本，实现用户交互界面。
- **`frames/`和`videos/`文件夹**：存储视频及其帧图像。

## 5. 技术选型

- **后端框架**：Flask - 轻量化、高效的Python框架，适合快速开发API服务。
- **数据库**：SQLite（可扩展为MySQL或PostgreSQL） - 用于嵌入向量和元数据的持久化存储。
- **视频处理库**：MoviePy - 提供视频帧提取和处理能力。
- **嵌入模型**：CLIP模型 - 生成图像和文本的语义嵌入，用于相似性计算。
- **前端技术**：HTML、CSS、JavaScript - 实现响应式UI和用户交互。

## 6. 未来扩展

- **改进搜索算法**：引入深度学习技术提高匹配准确度。
- **支持云存储**：扩展系统至云端，增加对大规模视频数据的存储能力。
- **实时处理功能**：添加实时处理模块，实现视频流的实时查询。

## 7. 里程碑

- **第一阶段**：完成前端界面和文件上传功能，提供简单的UI。
- **第二阶段**：后端完成视频帧提取和嵌入存储模块，实现基本查询功能。
- **第三阶段**：实现文本和语音的查询接口，前端展示查询结果。
- **第四阶段**：优化搜索和查询算法，提高用户体验和响应速度。
